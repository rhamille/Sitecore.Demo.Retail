@using Sitecore.Foundation.Assets.Models
@using Sitecore.Foundation.Assets.Services
@using Sitecore.Mvc.Analytics.Extensions
@using Sitecore.Foundation.Commerce.Website.Managers
@using Sitecore.Foundation.Commerce.Website.Models
@inherits WebViewPage
@{
    Layout = null;
}
<!DOCTYPE html>
<!--[if IE 9]><html lang="en" class="ie9 no-js"><![endif]-->
<!--[if !IE]><!-->
<html lang="@Sitecore.Context.Language.CultureInfo.TwoLetterISOLanguageName">
<!--<![endif]-->
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />


    <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.3/js.cookie.js"></script>


    @Html.Sitecore().VisitorIdentification()
    @RenderAssetsService.Current.RenderScript(ScriptLocation.Head)
    @RenderAssetsService.Current.RenderStyles()
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body class="@(Sitecore.Context.PageMode.IsExperienceEditor ? "header-static" : "") @(Sitecore.Context.PageMode.IsNormal ? "" : (Sitecore.Context.PageMode.IsExperienceEditor ? "pagemode-edit" : "pagemode-preview"))">


    <form id="_CRSFform" action="#" method="post">
        @Html.AntiForgeryToken()
    </form>

    <div id="main-container">
        <header class="bg-white @(Sitecore.Context.PageMode.IsExperienceEditor ? "header-static" : "header-fixed") header-has-top">
            @Html.Sitecore().Placeholder("header-top")
            <nav class="navbar navbar-default">
                <div class="container-fluid">

                    <img class="ariba-logo" src="/assets/images/SAP_Ariba_logo.png"/>

                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

                        <form id="signin" class="navbar-form navbar-right" role="form">
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
                                <input id="email" type="email" class="form-control" name="email" value="retailuser@test.com" placeholder="Email Address">
                            </div>
                            <div class="input-group">
                                <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
                                <input id="password" type="password" class="form-control" name="password" value="password1" placeholder="Password">
                            </div>
                            <button type="submit" class="btn btn-primary">Login</button>
                        </form>

                    </div>
                </div>
            </nav>
            @Html.Sitecore().Placeholder("navbar")
        </header>
        <section class="order-document">
            <div class="container">
                <xmp>

                </xmp>
            </div>
        </section>
        <main role="main">
           
            @Html.Sitecore().Placeholder("page-layout")
            <iframe id="retailFrame" src="" name="frame1" scrolling="auto" frameborder="no" align="center" width="100%" onload="" style="display: none;"></iframe>
        </main>
        <footer>
            @Html.Sitecore().Placeholder("footer")
        </footer>

        @Html.Sitecore().Placeholder("page-sidebar")
    </div>

<script>
    
    //User clicks login.
    $(":submit").click(function (evt) {
        evt.preventDefault();

        var iframe = $("iframe")[0].contentWindow;
        $("iframe").attr("src", "http://retail.dev.local");
    });

    var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
    var eventer = window[eventMethod];
    var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

    var iframe = $("iframe")[0].contentWindow;
    $(".order-document").hide();


    // Listen to message from child window(iframe)
    eventer(messageEvent, function (e) {
        //only accept messages from retail.dev.local
        if (event.origin !== "http://retail.dev.local")
            return;

        if (e.data.eventType === "resize") {
            document.getElementById("retailFrame").height = e.data.height;

        } else if (e.data.eventType === "getorder") {

            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    $(".order-document").show();
                    $("xmp").html(this.responseXML.documentElement);
                    var html = $("xmp").html();
                    $("xmp").html(" \"" + html + "\"");
                }
            };
            xhttp.open("GET", "http://retail.dev.local/api/storefront/Orders/PunchoutOrderRequest?userid=" + e.data.userid + "&orderid=" + e.data.orderid, true);
            xhttp.send();
           

        } else if (e.data.eventType === "login") {

            if (!e.data.result) {
                $("iframe").attr("src", "");
                $("iframe").hide();
                document.getElementById("retailFrame").height = 0;
            } else {
                $("iframe").show();
            }

        } else if (e.data.eventType === "bodyload") {

            var form = $("#signin")
                .serializeArray()
                .reduce(function (m, o) {
                    m[o.name] = o.value;
                    return m;
                },
                {});
            iframe.postMessage({ eventType: "login", value: form }, "http://retail.dev.local");

        }

    }, false);
</script>
</body>
</html>